name: docker build

on:
  push:
# TODO rework in a later commit
#    branches: [ master ]

# TODO build labgrid-base & cache it in separate job
jobs:
  docker-build-base:
    name: labgrid-base docker build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    # TODO see if we can cache version once
    - name: Setup Docker buildx
      uses: docker/setup-buildx-action@v2
    - name: Build labgrid-base docker image
      uses: docker/build-push-action@v3
      with:
        context: .
        push: false
        tags: labgrid-base
        #build-args: |
        #  VERSION=${{ steps.labgrid-version.outputs.VERSION }}
        file: dockerfiles/Dockerfile
        target: labgrid-base
        # TODO cache to somewhere & upload it as artifact which expires after job ?
        # https://github.com/actions/upload-artifact
        cache-to: type=local,dest=/tmp/.build-cache
    - name: Upload docker cache
      uses: actions/upload-artifact@v3
      with:
        name: labgrid-base
        path: /tmp/.build-cache
        retention-days: 5

  docker-build:
    name: labgrid-${{ matrix.target }} docker build
    runs-on: ubuntu-latest
    needs: docker-build-base
    strategy:
      matrix:
        target:
          - client
          - exporter
          - coordinator
    steps:
    - uses: actions/checkout@v3
    - name: Install system dependencies
      run: |
        sudo apt install -yq python3-pip
        python3 -m pip install setuptools_scm
    - name: Extract Labgrid version from scm
      id: labgrid-version
      # TODO version `0.1.dev1-g2bd3f48` is wrong ?
      run: echo "VERSION=$(python -m setuptools_scm)" >> $GITHUB_OUTPUT
      #run: echo "VERSION=0.4" >> $GITHUB_OUTPUT
    - name: Download docker cache
      uses: actions/download-artifact@v3
      with:
        name: labgrid-base
        path: /tmp/.build-cache

# TODO add qemu when multiplatform
#    - name: Set up QEMU
#      uses: docker/setup-qemu-action@v2

    - name: Setup Docker buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

# TODO add meta step

    - name: Build labgrid-${{ matrix.target }} docker image
      uses: docker/build-push-action@v3
      with:
        context: .
        # my fork is set to "obbardc/labgrid-"
        # TODO change to true and push to ${{ secrets.DOCKERHUB_PREFIX }}
        # TODO push later ?
        push: true
        # TODO check tags / labels
        #tags: ${{ steps.meta.outputs.tags }}
        tags: ${{ secrets.DOCKERHUB_PREFIX }}${{ matrix.target }}:latest
        #labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ steps.labgrid-version.outputs.VERSION }}
        file: dockerfiles/Dockerfile
        target: labgrid-${{ matrix.target }}
        # TODO test the cache of labgrid-base from prev stage
        cache-from: type=local,src=/tmp/.build-cache

#    - name: Build docker image
#      run: |
#        ./dockerfiles/build.sh
#        docker-compose -f dockerfiles/staging/docker-compose.yml up --exit-code-from client client
#        docker-compose -f dockerfiles/staging/docker-compose.yml down
#        docker images
#        docker tag labgrid-client ${{ secrets.DOCKERHUB_PREFIX }}client
#        docker tag labgrid-exporter ${{ secrets.DOCKERHUB_PREFIX }}exporter
#        docker tag labgrid-coordinator ${{ secrets.DOCKERHUB_PREFIX }}coordinator
#        docker push ${{ secrets.DOCKERHUB_PREFIX }}client
#        docker push ${{ secrets.DOCKERHUB_PREFIX }}exporter
#        docker push ${{ secrets.DOCKERHUB_PREFIX }}coordinator
#        docker images
